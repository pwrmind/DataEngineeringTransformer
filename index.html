<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Engineering Transformer</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .pipeline-visualization {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .transformation-block {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .data-table-container {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.875rem;
        }
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        .node {
            cursor: pointer;
        }
        .node:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="app" x-data="app()">
        <!-- Визуализация пайплайна -->
        <div class="container-sm mt-3">
            <div class="pipeline-visualization">
                <h5 class="mb-3"><i class="fas fa-project-diagram me-2"></i>Pipeline Visualization</h5>
                <div id="pipelineChart"></div>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="container-sm">
            <!-- Компонент загрузки данных -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-database me-2"></i>Data Loader</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label small">Upload JSON File</label>
                                    <input type="file" class="form-control form-control-sm" @change="handleFileUpload($event)" accept=".json">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Or paste JSON</label>
                                    <textarea 
                                        x-model="jsonInput" 
                                        class="form-control form-control-sm" 
                                        rows="3" 
                                        placeholder='[{"id": 1, "name": "John"}]'
                                    ></textarea>
                                </div>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <button 
                                        @click="loadCustomData(jsonInput)" 
                                        class="btn btn-sm btn-primary w-100"
                                    >
                                        <i class="fas fa-upload me-1"></i>Load from Text
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button 
                                        @click="jsonInput = JSON.stringify(originalData, null, 2)" 
                                        class="btn btn-sm btn-outline-secondary w-100"
                                    >
                                        <i class="fas fa-redo me-1"></i>Reset to Sample
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Таблица данных -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Data Preview 
                                <small class="text-muted">(Showing <span x-text="currentData.length"></span> items)</small>
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" @click="copyToClipboard()">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                                <button class="btn btn-sm btn-outline-success" @click="exportData()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="data-table-container">
                                <table class="table table-sm table-striped mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <template x-for="(value, key) in currentData[0] || {}" :key="key">
                                                <th x-text="key"></th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(item, index) in currentData" :key="index">
                                            <tr>
                                                <template x-for="(value, key) in item" :key="key">
                                                    <td x-text="value"></td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Система шагов трансформации -->
            <div class="row mt-4">
                <div class="col-12">
                    <h5><i class="fas fa-cogs me-2"></i>Transformation Pipeline</h5>

                    <!-- Контейнер для шагов трансформации -->
                    <div id="transformationSteps">
                        <template x-for="(step, index) in pipelineSteps" :key="step.id">
                            <div class="transformation-block">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="step-number" x-text="index + 1"></div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" x-text="'Step ' + (index + 1) + ': ' + step.method"></h6>
                                        <small class="text-muted" x-text="'Input: ' + (currentResults[index] ? currentResults[index].length : 0) + ' items'"></small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger" @click="removeStep(index)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Панель выбора метода -->
                                <div class="row g-2 mb-3">
                                    <div class="col-sm-6">
                                        <label class="form-label small">Transformation Method</label>
                                        <select 
                                            class="form-select form-select-sm" 
                                            x-model="step.method"
                                            @change="step.parameters = getDefaultParameters(step.method)"
                                        >
                                            <option value="map">Map</option>
                                            <option value="filter">Filter</option>
                                            <option value="reduce">Reduce</option>
                                            <option value="flatMap">FlatMap</option>
                                            <option value="slice">Slice</option>
                                            <option value="concat">Concat</option>
                                            <option value="join">Join</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label small">Step Name</label>
                                        <input type="text" class="form-control form-control-sm" x-model="step.name" :placeholder="'Step ' + (index + 1)">
                                    </div>
                                </div>

                                <!-- Динамическая панель параметров -->
                                <div x-html="getParameterPanel(step, index)"></div>

                                <!-- Кнопка применения и результат -->
                                <div class="row align-items-center mt-3">
                                    <div class="col">
                                        <button 
                                            class="btn btn-sm btn-primary" 
                                            @click="executeStep(index)"
                                            :disabled="!isStepExecutable(index)"
                                        >
                                            <i class="fas fa-play me-1"></i>Apply Transformation
                                        </button>
                                    </div>
                                    <div class="col-auto">
                                        <small class="text-muted" 
                                               x-text="step.result ? 'Output: ' + (Array.isArray(step.result) ? step.result.length + ' items' : step.result) : ''">
                                        </small>
                                    </div>
                                </div>

                                <!-- Мини-таблица с результатом -->
                                <div x-show="step.result && Array.isArray(step.result) && step.result.length > 0" class="mt-3">
                                    <div class="data-table-container">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <template x-for="(value, key) in step.result[0]" :key="key">
                                                        <th x-text="key"></th>
                                                    </template>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="(item, itemIndex) in step.result.slice(0, 5)" :key="itemIndex">
                                                    <tr>
                                                        <template x-for="(value, key) in item" :key="key">
                                                            <td x-text="value"></td>
                                                        </template>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                    <small class="text-muted" x-show="step.result.length > 5">
                                        Showing first 5 of <span x-text="step.result.length"></span> items
                                    </small>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Кнопка добавления шага ПОД всеми шагами -->
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-success" @click="addStep()">
                                <i class="fas fa-plus me-1"></i>Add Transformation Step
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    
    <script>
        function app() {
            return {
                // Исходные данные
                originalData: [],
                
                // Шаги трансформации
                pipelineSteps: [],
                
                // Результаты после каждого шага
                currentResults: [],
                
                // Следующий ID для шага
                nextStepId: 1,
                
                // JSON input
                jsonInput: '',
                
                // Текущие данные для отображения (последний шаг)
                get currentData() {
                    return this.currentResults.length > 0 
                        ? this.currentResults[this.currentResults.length - 1] 
                        : [];
                },

                // Инициализация тестовыми данными
                init() {
                    // Тестовые данные
                    this.originalData = [
                        { id: 1, name: "Alice", age: 30, city: "London", active: true },
                        { id: 2, name: "Bob", age: 25, city: "New York", active: false },
                        { id: 3, name: "Charlie", age: 35, city: "London", active: true },
                        { id: 4, name: "Diana", age: 28, city: "Paris", active: true },
                        { id: 5, name: "Eve", age: 32, city: "Berlin", active: false }
                    ];
                    this.currentResults = [JSON.parse(JSON.stringify(this.originalData))];
                    this.jsonInput = JSON.stringify(this.originalData, null, 2);
                    
                    // Инициализация D3 визуализации
                    this.initPipelineVisualization();
                },

                // Загрузка пользовательских данных
                loadCustomData(jsonString) {
                    const validation = this.validateJSON(jsonString);
                    if (!validation.isValid) {
                        this.showNotification(validation.error, 'error');
                        return;
                    }
                    
                    this.originalData = validation.data;
                    this.currentResults = [JSON.parse(JSON.stringify(this.originalData))];
                    this.pipelineSteps = [];
                    this.nextStepId = 1;
                    this.updatePipelineVisualization();
                    this.showNotification('Data loaded successfully!', 'success');
                },

                // Обработка загрузки файла
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.jsonInput = e.target.result;
                            this.loadCustomData(e.target.result);
                            this.showNotification('File loaded successfully!', 'success');
                        } catch (error) {
                            this.showNotification('Error reading file: ' + error.message, 'error');
                        }
                    };
                    reader.onerror = () => {
                        this.showNotification('Error reading file', 'error');
                    };
                    reader.readAsText(file);
                },

                // Валидация JSON
                validateJSON(jsonString) {
                    try {
                        const parsed = JSON.parse(jsonString);
                        if (!Array.isArray(parsed)) {
                            return { isValid: false, error: 'Data must be a JSON array' };
                        }
                        return { isValid: true, data: parsed };
                    } catch (error) {
                        return { isValid: false, error: 'Invalid JSON format' };
                    }
                },

                // Добавление шага
                addStep() {
                    this.pipelineSteps.push({
                        id: this.nextStepId++,
                        method: 'map',
                        name: '',
                        parameters: this.getDefaultParameters('map'),
                        result: null,
                        error: null
                    });
                },

                // Удаление шага
                removeStep(index) {
                    this.pipelineSteps.splice(index, 1);
                    // Пересчитываем результаты для оставшихся шагов
                    this.recalculatePipeline();
                },

                // Получение параметров по умолчанию для метода
                getDefaultParameters(method) {
                    const defaults = {
                        map: { sourceField: '', expression: 'item' },
                        filter: { condition: 'true' },
                        reduce: { initialValue: '0', reducerFunction: 'acc + item' },
                        flatMap: { expression: 'item' },
                        slice: { start: '0', end: '' },
                        concat: { arrayToConcat: '[]' },
                        join: { separator: ',', sourceField: '' }
                    };
                    return { ...defaults[method] };
                },

                // Получение панели параметров
                getParameterPanel(step, index) {
                    const method = step.method;
                    
                    const panels = {
                        map: `
                            <div class="row g-2">
                                <div class="col-sm-6">
                                    <label class="form-label small">Source Field (optional)</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.sourceField" 
                                           placeholder="fieldName">
                                </div>
                                <div class="col-sm-6">
                                    <label class="form-label small">Expression</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.expression" 
                                           placeholder="item * 2">
                                </div>
                                <div class="col-12">
                                    <small class="text-muted">
                                        Use <code>item</code> to reference current element. Example: <code>item.age * 2</code>
                                    </small>
                                </div>
                            </div>
                        `,
                        
                        filter: `
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small">Condition</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.condition" 
                                           placeholder="item.age > 25">
                                    <small class="text-muted">
                                        Use <code>item</code> to reference current element. Example: <code>item.active && item.age > 30</code>
                                    </small>
                                </div>
                            </div>
                        `,
                        
                        reduce: `
                            <div class="row g-2">
                                <div class="col-sm-6">
                                    <label class="form-label small">Initial Value</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.initialValue" 
                                           placeholder='0, "[]", "{}"'>
                                </div>
                                <div class="col-sm-6">
                                    <label class="form-label small">Reducer Function</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.reducerFunction" 
                                           placeholder="acc + item.age">
                                </div>
                                <div class="col-12">
                                    <small class="text-muted">
                                        Use <code>acc</code> for accumulator and <code>item</code> for current element. Example: <code>acc + item.value</code>
                                    </small>
                                </div>
                            </div>
                        `,
                        
                        flatMap: `
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small">Expression</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.expression" 
                                           placeholder="item.phones">
                                    <small class="text-muted">
                                        Should return an array. Example: <code>item.phoneNumbers</code>
                                    </small>
                                </div>
                            </div>
                        `,
                        
                        slice: `
                            <div class="row g-2">
                                <div class="col-sm-6">
                                    <label class="form-label small">Start Index</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.start" 
                                           placeholder="0">
                                </div>
                                <div class="col-sm-6">
                                    <label class="form-label small">End Index (optional)</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.end" 
                                           placeholder="10">
                                </div>
                            </div>
                        `,
                        
                        concat: `
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small">Array to Concatenate</label>
                                    <textarea class="form-control form-control-sm" 
                                              x-model="pipelineSteps[${index}].parameters.arrayToConcat" 
                                              rows="2" 
                                              placeholder='[{"id": 6, "name": "Frank"}]'></textarea>
                                    <small class="text-muted">
                                        Enter valid JSON array
                                    </small>
                                </div>
                            </div>
                        `,
                        
                        join: `
                            <div class="row g-2">
                                <div class="col-sm-6">
                                    <label class="form-label small">Separator</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.separator" 
                                           placeholder=",">
                                </div>
                                <div class="col-sm-6">
                                    <label class="form-label small">Source Field (optional)</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           x-model="pipelineSteps[${index}].parameters.sourceField" 
                                           placeholder="name">
                                </div>
                            </div>
                        `
                    };
                    
                    return panels[method] || '<div>Unknown method</div>';
                },

                // Проверка возможности выполнения шага
                isStepExecutable(index) {
                    if (index === 0) {
                        return this.originalData.length > 0;
                    }
                    return this.pipelineSteps[index - 1].result !== null;
                },

                // Выполнение шага (с иммутабельностью)
                executeStep(index) {
                    try {
                        const step = this.pipelineSteps[index];
                        
                        // Создаем глубокую копию данных предыдущего шага
                        let inputData;
                        if (index === 0) {
                            inputData = JSON.parse(JSON.stringify(this.originalData));
                        } else {
                            const prevResult = this.pipelineSteps[index - 1].result;
                            inputData = Array.isArray(prevResult) 
                                ? JSON.parse(JSON.stringify(prevResult))
                                : prevResult;
                        }
                        
                        if (!inputData || (Array.isArray(inputData) && inputData.length === 0)) {
                            throw new Error('No input data available');
                        }

                        let result;
                        switch (step.method) {
                            case 'map':
                                result = this.executeMap(inputData, step.parameters);
                                break;
                            case 'filter':
                                result = this.executeFilter(inputData, step.parameters);
                                break;
                            case 'reduce':
                                result = this.executeReduce(inputData, step.parameters);
                                break;
                            case 'flatMap':
                                result = this.executeFlatMap(inputData, step.parameters);
                                break;
                            case 'slice':
                                result = this.executeSlice(inputData, step.parameters);
                                break;
                            case 'concat':
                                result = this.executeConcat(inputData, step.parameters);
                                break;
                            case 'join':
                                result = this.executeJoin(inputData, step.parameters);
                                break;
                            default:
                                throw new Error(`Unknown method: ${step.method}`);
                        }

                        step.result = result;
                        step.error = null;
                        
                        // Сохраняем результат (уже иммутабельный)
                        this.currentResults[index] = Array.isArray(result) 
                            ? JSON.parse(JSON.stringify(result)) 
                            : result;
                        
                        // Пересчитываем последующие шаги
                        this.recalculateSubsequentSteps(index);
                        this.updatePipelineVisualization();
                        
                    } catch (error) {
                        this.pipelineSteps[index].error = error.message;
                        console.error('Execution error:', error);
                        this.showNotification(`Error in step ${index + 1}: ${error.message}`, 'error');
                    }
                },

                // Методы выполнения трансформаций
                executeMap(data, params) {
                    const { sourceField, expression } = params;
                    return data.map(item => {
                        const value = sourceField ? item[sourceField] : item;
                        // Безопасное выполнение выражения
                        const func = new Function('item', `return ${expression}`);
                        return func(value);
                    });
                },

                executeFilter(data, params) {
                    const { condition } = params;
                    return data.filter(item => {
                        const func = new Function('item', `return ${condition}`);
                        return func(item);
                    });
                },

                executeReduce(data, params) {
                    const { initialValue, reducerFunction } = params;
                    const initial = JSON.parse(initialValue);
                    return data.reduce((acc, item) => {
                        const func = new Function('acc', 'item', `return ${reducerFunction}`);
                        return func(acc, item);
                    }, initial);
                },

                executeFlatMap(data, params) {
                    const { expression } = params;
                    return data.flatMap(item => {
                        const func = new Function('item', `return ${expression}`);
                        const result = func(item);
                        return Array.isArray(result) ? result : [result];
                    });
                },

                executeSlice(data, params) {
                    const { start, end } = params;
                    const startNum = parseInt(start) || 0;
                    const endNum = end ? parseInt(end) : undefined;
                    return data.slice(startNum, endNum);
                },

                executeConcat(data, params) {
                    const { arrayToConcat } = params;
                    try {
                        const arrayToAdd = JSON.parse(arrayToConcat);
                        if (!Array.isArray(arrayToAdd)) {
                            throw new Error('Must be a valid array');
                        }
                        return data.concat(arrayToAdd);
                    } catch (error) {
                        throw new Error('Invalid array format: ' + error.message);
                    }
                },

                executeJoin(data, params) {
                    const { separator, sourceField } = params;
                    const arrayToJoin = sourceField ? data.map(item => item[sourceField]) : data;
                    return arrayToJoin.join(separator || ',');
                },

                // Пересчет последующих шагов
                recalculateSubsequentSteps(fromIndex) {
                    for (let i = fromIndex + 1; i < this.pipelineSteps.length; i++) {
                        this.executeStep(i);
                    }
                },

                // Полный пересчет пайплайна
                recalculatePipeline() {
                    this.currentResults = [JSON.parse(JSON.stringify(this.originalData))];
                    
                    for (let i = 0; i < this.pipelineSteps.length; i++) {
                        this.executeStep(i);
                    }
                    
                    this.updatePipelineVisualization();
                },

                // Инициализация D3 визуализации
                initPipelineVisualization() {
                    this.updatePipelineVisualization();
                },

                // Обновление D3 визуализации (исправленное выравнивание)
                updatePipelineVisualization() {
                    const container = document.getElementById('pipelineChart');
                    if (!container) return;
                    
                    const width = container.clientWidth;
                    const height = 120;
                    
                    // Очищаем предыдущую визуализацию
                    d3.select('#pipelineChart').selectAll('*').remove();
                    
                    const svg = d3.select('#pipelineChart')
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height);
                    
                    // Создаем узлы для визуализации
                    const nodes = [];
                    
                    // Начальный узел (исходные данные)
                    nodes.push({
                        id: 'source',
                        name: 'Source Data',
                        type: 'source',
                        count: this.originalData.length,
                        result: this.originalData
                    });
                    
                    // Узлы для каждого шага
                    this.pipelineSteps.forEach((step, index) => {
                        nodes.push({
                            id: `step-${step.id}`,
                            name: step.name || `Step ${index + 1}: ${step.method}`,
                            type: 'step',
                            method: step.method,
                            result: step.result,
                            index: index
                        });
                    });
                    
                    // Рассчитываем общую ширину и центрируем
                    const nodeWidth = 120;
                    const nodeHeight = 60;
                    const horizontalSpacing = 40;
                    const totalWidth = nodes.length * (nodeWidth + horizontalSpacing) - horizontalSpacing;
                    const startX = (width - totalWidth) / 2;
                    
                    let currentX = startX;
                    
                    // Добавляем маркер для стрелок
                    svg.append('defs').append('marker')
                        .attr('id', 'arrowhead')
                        .attr('viewBox', '0 -5 10 10')
                        .attr('refX', 8)
                        .attr('refY', 0)
                        .attr('markerWidth', 6)
                        .attr('markerHeight', 6)
                        .attr('orient', 'auto')
                        .append('path')
                        .attr('d', 'M0,-5L10,0L0,5')
                        .attr('fill', '#6c757d');
                    
                    // Рисуем соединения
                    for (let i = 0; i < nodes.length - 1; i++) {
                        const x1 = currentX + nodeWidth;
                        const x2 = currentX + nodeWidth + horizontalSpacing;
                        const y = height / 2;
                        
                        svg.append('line')
                            .attr('x1', x1)
                            .attr('y1', y)
                            .attr('x2', x2)
                            .attr('y2', y)
                            .attr('stroke', '#dee2e6')
                            .attr('stroke-width', 2)
                            .attr('marker-end', 'url(#arrowhead)');
                        
                        currentX += nodeWidth + horizontalSpacing;
                    }
                    
                    // Сбрасываем позицию для узлов
                    currentX = startX;
                    
                    // Рисуем узлы
                    nodes.forEach((node, index) => {
                        const y = height / 2;
                        
                        const group = svg.append('g')
                            .attr('transform', `translate(${currentX}, ${y})`)
                            .attr('class', 'node')
                            .style('cursor', 'pointer')
                            .on('click', () => {
                                if (node.type === 'step') {
                                    const element = document.querySelector(`[x-data] .transformation-block:nth-child(${node.index + 1})`);
                                    if (element) {
                                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                                }
                            });
                        
                        // Прямоугольник узла
                        group.append('rect')
                            .attr('width', nodeWidth)
                            .attr('height', nodeHeight)
                            .attr('x', -nodeWidth / 2)
                            .attr('y', -nodeHeight / 2)
                            .attr('rx', 8)
                            .attr('fill', node.type === 'source' ? '#28a745' : '#007bff')
                            .attr('stroke', '#fff')
                            .attr('stroke-width', 2);
                        
                        // Текст узла
                        group.append('text')
                            .attr('text-anchor', 'middle')
                            .attr('dy', -5)
                            .attr('fill', 'white')
                            .style('font-size', '12px')
                            .style('font-weight', 'bold')
                            .text(node.type === 'source' ? 'SOURCE' : node.method.toUpperCase());
                        
                        group.append('text')
                            .attr('text-anchor', 'middle')
                            .attr('dy', 10)
                            .attr('fill', 'white')
                            .style('font-size', '10px')
                            .text(node.name.length > 15 ? node.name.substring(0, 15) + '...' : node.name);
                        
                        // Информация о данных
                        let dataInfo;
                        if (node.type === 'source') {
                            dataInfo = `${node.count} items`;
                        } else {
                            if (node.result === null) {
                                dataInfo = 'not executed';
                            } else if (Array.isArray(node.result)) {
                                dataInfo = `${node.result.length} items`;
                            } else {
                                dataInfo = typeof node.result === 'string' 
                                    ? (node.result.length > 10 ? node.result.substring(0, 10) + '...' : node.result)
                                    : String(node.result);
                            }
                        }
                        
                        group.append('text')
                            .attr('text-anchor', 'middle')
                            .attr('dy', 25)
                            .attr('fill', 'white')
                            .style('font-size', '9px')
                            .style('font-style', 'italic')
                            .text(dataInfo);
                        
                        currentX += nodeWidth + horizontalSpacing;
                    });
                },

                // Экспорт данных
                exportData() {
                    const dataStr = JSON.stringify(this.currentData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'transformed-data.json';
                    a.click();
                    URL.revokeObjectURL(url);
                },

                // Копирование в буфер обмена
                copyToClipboard() {
                    const dataStr = JSON.stringify(this.currentData, null, 2);
                    navigator.clipboard.writeText(dataStr).then(() => {
                        this.showNotification('Data copied to clipboard!', 'success');
                    }).catch(err => {
                        this.showNotification('Failed to copy data', 'error');
                    });
                },

                // Показать уведомление
                showNotification(message, type = 'info') {
                    // Создаем элемент уведомления
                    const notification = document.createElement('div');
                    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
                    notification.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    // Добавляем в начало контейнера
                    const container = document.querySelector('.container-sm');
                    container.insertBefore(notification, container.firstChild);
                    
                    // Автоматически скрываем через 3 секунды
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>
